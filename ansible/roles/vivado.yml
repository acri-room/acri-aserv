---
- hosts: fserv9

  vars:
    versions:
      - '2021.1'
      - '2021.2'
      - '2022.1'
      - '2022.2'
      - '2023.1'

  tasks:
    - name: Vivado crash workaround - Add LD_PRELOAD
      ansible.builtin.blockinfile:
        path: /tools/Xilinx/Vivado/{{ item }}/bin/setupEnv.sh
        block: |
          export LD_PRELOAD=/lib/x86_64-linux-gnu/libudev.so.1:/lib/x86_64-linux-gnu/libc.so.6
      loop: "{{ versions }}"

    - name: Vivado crash workaround - Remove LD_PRELOAD
      ansible.builtin.blockinfile:
        path: /tools/Xilinx/Vivado/{{ item.0 }}/gnu/microblaze/lin/bin/{{ item.1 }}
        insertafter: "^#!"
        block: |
          export LD_PRELOAD=
      with_nested:
        - "{{ versions }}"
        - ['mb-addr2line', 'mb-ar', 'mb-as', 'mb-c++', 'mb-c++filt', 'mb-cpp', 'mb-dwp', 'mb-elfedit', 'mb-g++', 'mb-gcc', 'mb-gcc-ar', 'mb-gcc-nm', 'mb-gcov', 'mb-gcov-dump', 'mb-gcov-tool', 'mb-gdb-add-index', 'mb-ld', 'mb-ld.bfd', 'mb-ld.gold', 'mb-nm', 'mb-objcopy', 'mb-ranlib', 'mb-readelf', 'mb-size', 'mb-strings', 'mb-strip']

    - name: Alveo board files
      ansible.builtin.unarchive:
        src: https://www.xilinx.com/bin/public/openDownload?filename={{ item.1 }}
        dest: /tools/Xilinx/Vivado/{{ item.0 }}/data/xhub/boards/XilinxBoardStore/boards/Xilinx
        remote_src: yes
      with_nested:
        - "{{ versions }}"
        - ['au200_board_files_20200616.zip', 'au250_board_files_20200616.zip']
        #- ['au200_board_files_20200616.zip', 'au250_board_files_20200616.zip', 'au50_boardfiles_v1_3_20211104.zip']

